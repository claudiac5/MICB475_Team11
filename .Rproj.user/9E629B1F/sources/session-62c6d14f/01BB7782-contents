qime2 codes

# on the server (qiime2-amplicon-2025.4)
cd /data

# make working directory + folders
mkdir -p project2_gastric_cancer_qiime2/{0_inputs,1_import,2_dada2,3_taxonomy,4_filtering,5_tree_rarefaction}
cd /data/project2_gastric_cancer_qiime2

# copy inputs
cp /datasets/project_2/gastric_cancer/gastric_cancer_manifest.tsv 0_inputs/manifest_raw.tsv
cp /datasets/project_2/gastric_cancer/gastric_cancer_metadata.tsv 0_inputs/metadata.tsv

# create single-end QIIME2 manifest (TSV) with direction=forward
awk -F'\t' 'BEGIN{OFS="\t"}
NR==1 {print "sample-id","absolute-filepath","direction"; next}
{
  gsub("\r","",$1); gsub("\r","",$2);
  if($1!="" && $2!="") print $1,$2,"forward"
}' 0_inputs/manifest_raw.tsv > 0_inputs/manifest.tsv

# import into QIIME2
qiime tools import \
  --type "SampleData[SequencesWithQuality]" \
  --input-format SingleEndFastqManifestPhred33V2 \
  --input-path 0_inputs/manifest.tsv \
  --output-path 1_import/demux_seqs.qza

# summarize demux
qiime demux summarize \
  --i-data 1_import/demux_seqs.qza \
  --o-visualization 1_import/demux_summary.qzv



# DADA2 denoise (single-end; trunc-len=0 = no truncation)
# screen -S dada2_run2
# cd /data/project2_gastric_cancer_qiime2
qiime dada2 denoise-single \
  --i-demultiplexed-seqs 1_import/demux_seqs.qza \
  --p-trim-left 0 \
  --p-trunc-len 0 \
  --o-representative-sequences 2_dada2/rep-seqs.qza \
  --o-table 2_dada2/table.qza \
  --o-denoising-stats 2_dada2/stats.qza

# summarize feature table after denoising (sample counts + depth distribution)
qiime feature-table summarize \
  --i-table 2_dada2/table.qza \
  --o-visualization 2_dada2/table_summary.qzv \
  --m-sample-metadata-file 0_inputs/metadata.tsv

# view DADA2 denoising stats table
qiime metadata tabulate \
  --m-input-file 2_dada2/stats.qza \
  --o-visualization 2_dada2/denoising_stats.qzv

# view representative sequences (ASVs)
qiime feature-table tabulate-seqs \
  --i-data 2_dada2/rep-seqs.qza \
  --o-visualization 2_dada2/rep_seqs.qzv


# assign taxonomy using pretrained SILVA V4 classifier (matches primers in paper: 515F/806R)
qiime feature-classifier classify-sklearn \
  --i-classifier /datasets/classifiers/silva-138-99-515-806-nb-classifier.qza \
  --i-reads 2_dada2/rep-seqs.qza \
  --o-classification 3_taxonomy/taxonomy.qza

# taxonomy table visualization
qiime metadata tabulate \
  --m-input-file 3_taxonomy/taxonomy.qza \
  --o-visualization 3_taxonomy/taxonomy.qzv

# taxa barplots (quick overview of composition by metadata columns)
qiime taxa barplot \
  --i-table 2_dada2/table.qza \
  --i-taxonomy 3_taxonomy/taxonomy.qza \
  --m-metadata-file 0_inputs/metadata.tsv \
  --o-visualization 3_taxonomy/taxa_barplot.qzv


########################################
# 3) FILTERING
########################################

# (required) remove mitochondria/chloroplast features
qiime taxa filter-table \
  --i-table 2_dada2/table.qza \
  --i-taxonomy 3_taxonomy/taxonomy.qza \
  --p-exclude mitochondria,chloroplast \
  --o-filtered-table 4_filtering/table_no_mito_chloro.qza

# (optional but recommended) summarize after mito/chloro filtering
qiime feature-table summarize \
  --i-table 4_filtering/table_no_mito_chloro.qza \
  --o-visualization 4_filtering/table_no_mito_chloro.qzv \
  --m-sample-metadata-file 0_inputs/metadata.tsv

# (metadata-based filtering for our research question)
# keep only gastric cancer (GC) samples AND only Lauren intestinal vs diffused subtypes
qiime feature-table filter-samples \
  --i-table 4_filtering/table_no_mito_chloro.qza \
  --m-metadata-file 0_inputs/metadata.tsv \
  --p-where "[Group]='Gastric cancer (GC)' AND [Histopathology      (lauren classification)] IN ('Intestinal type','Diffused type')" \
  --o-filtered-table 4_filtering/table_gc_intestinal_diffuse.qza

# summarize the final analysis table (this is the table you’ll use for rarefaction/tree)
qiime feature-table summarize \
  --i-table 4_filtering/table_gc_intestinal_diffuse.qza \
  --o-visualization 4_filtering/table_gc_intestinal_diffuse.qzv \
  --m-sample-metadata-file 0_inputs/metadata.tsv

# build rooted phylogenetic tree (required for phylogenetic diversity + UniFrac)
qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences 2_dada2/rep-seqs.qza \
  --o-alignment 5_tree_rarefaction/aligned-rep-seqs.qza \
  --o-masked-alignment 5_tree_rarefaction/masked-aligned-rep-seqs.qza \
  --o-tree 5_tree_rarefaction/unrooted-tree.qza \
  --o-rooted-tree 5_tree_rarefaction/rooted-tree.qza

qiime diversity alpha-rarefaction \
  --i-table 4_filtering/table_gc_intestinal_diffuse.qza \
  --i-phylogeny 5_tree_rarefaction/rooted-tree.qza \
  --p-max-depth 40000 \
  --m-metadata-file 0_inputs/metadata.tsv \
  --o-visualization 5_tree_rarefaction/alpha_rarefaction_gc_int_diff_40k.qzv

# calculate alpha and beta diversity metrics 
qiime diversity core-metrics-phylogenetic \
  --i-phylogeny 5_tree_rarefaction/rooted-tree.qza \
  --i-table 4_filtering/table_gc_intestinal_diffuse.qza \
  --p-sampling-depth 10222 \
  --m-metadata-file 0_inputs/metadata.tsv \
  --output-dir 6_core_metrics

# Faith's PD
qiime diversity alpha-group-significance \
  --i-alpha-diversity 6_core_metrics/faith_pd_vector.qza \
  --m-metadata-file 0_inputs/metadata.tsv \
  --o-visualization 6_core_metrics/faith_pd_diffuse_vs_intestinal.qzv

# Shannon
qiime diversity alpha-group-significance \
  --i-alpha-diversity 6_core_metrics/shannon_vector.qza \
  --m-metadata-file 0_inputs/metadata.tsv \
  --o-visualization 6_core_metrics/shannon_diffuse_vs_intestinal.qzv

# Bray-Curtis
qiime diversity beta-group-significance \
  --i-distance-matrix 6_core_metrics/bray_curtis_distance_matrix.qza \
  --m-metadata-file 0_inputs/metadata.tsv \
  --m-metadata-column "Histopathology      (lauren classification)" \
  --p-method permanova \
  --p-permutations 999 \
  --o-visualization 6_core_metrics/bray_diffuse_vs_intestinal_permanova.qzv

# Weighted UniFrac
qiime diversity beta-group-significance \
  --i-distance-matrix 6_core_metrics/weighted_unifrac_distance_matrix.qza \
  --m-metadata-file 0_inputs/metadata.tsv \
  --m-metadata-column "Histopathology      (lauren classification)" \
  --p-method permanova \
  --p-permutations 999 \
  --o-visualization 6_core_metrics/weighted_unifrac_diffuse_vs_intestinal_permanova.qzv

# Unweighted UniFrac
qiime diversity beta-group-significance \
  --i-distance-matrix 6_core_metrics/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file 0_inputs/metadata.tsv \
  --m-metadata-column "Histopathology      (lauren classification)" \
  --p-method permanova \
  --p-permutations 999 \
  --o-visualization 6_core_metrics/unweighted_unifrac_diffuse_vs_intestinal_permanova.qzv


# create export folder for downstream R analysis
cd /data/project2_gastric_cancer_qiime2
mkdir -p 7_export_for_R

# export filtered feature table (GC intestinal vs diffuse subset)
qiime tools export \
  --input-path 4_filtering/table_gc_intestinal_diffuse.qza \
  --output-path 7_export_for_R/table_gc_intestinal_diffuse_export

# convert BIOM feature table to TSV for R import
biom convert \
  -i 7_export_for_R/table_gc_intestinal_diffuse_export/feature-table.biom \
  -o 7_export_for_R/feature_table_gc_intestinal_diffuse.tsv \
  --to-tsv

# export taxonomy assignments (SILVA)
qiime tools export \
  --input-path 3_taxonomy/taxonomy.qza \
  --output-path 7_export_for_R/taxonomy_export

# move exported taxonomy file to main export folder
mv 7_export_for_R/taxonomy_export/taxonomy.tsv \
   7_export_for_R/taxonomy.tsv

# export rooted phylogenetic tree (required for UniFrac + Faith’s PD in R)
qiime tools export \
  --input-path 5_tree_rarefaction/rooted-tree.qza \
  --output-path 7_export_for_R/tree_export

# copy metadata file used for filtering and analysis
cp 0_inputs/metadata.tsv 7_export_for_R/metadata.tsv

